<element name="racer-blog" attributes="collectionPath">
  <template>
    <style>
      @host {
        racer-blog {
          display: block;
          margin: 0 auto;
          width: 600px;
        }
      }
      #new {
        margin: 0 auto;
        border: none;
        background: none;
        font-size: 40px;
        cursor: pointer;
      }
      #new:hover {
        color: rgb(206, 26, 26);
      }
    </style>
    <button id="new" style="display:none;">+</button>
    <racer-list id="list" itemType="smart-post" listType="div" at="{{collectionPath}}" reverse="true" on-model:load="onModelLoad" on-item:delete="onItemDelete"></racer-collection>
  </template>
  <script>
    Polymer.register(this, {
      ready: function() {
        if (window.racer) {
          this.racer = window.racer;  
        }
        this.$.new.addEventListener("click", this.addNew.bind(this))
      },
      set racer(racer) {
        var self = this;

        racer.ready(function(model) {
          self.model = model;
        });
      },
      set model(model) {
        var self = this;

        if (model.get("_page.authorized")) {
          this._authorize();
        } else {
          this._unauthorize();
        }
        model.on("error", function(err) {
          if (err.message === "unauthorized") {
            self._unauthorize();
          }
        });
        this.$.list.model = model;
      },
      onItemDelete: function() {
        this.fire("post:delete");
      },
      onModelLoad: function() {
        var self = this,
        count = 0;

        this.$.list.items.forEach(function(item, i) {
          var update = function() {
            count++;
            if (count >= self.$.list.items.length) {
              item.child.removeEventListener(update);
              self.fire("load");
            }
          };
          item.child.addEventListener("update", update);
          item.child.addEventListener("remove", function() {
            self.$.list.del(i);
          });
        });
      },
      _authorize: function() {
        this.$.list.itemAttributes = {editable: true};
        this.$.new.style.display = "block";
      },
      _unauthorize: function() {
        this.$.list.itemAttributes = null;
        this.$.new.style.display = "none";
        this.$.list.items.forEach(function(item) {
          item.child.editable = null;
        });
      },
      addNew: function() {
        this.$.list.push({
          body: ""
        });
      }
    });
  </script>
  </element>
