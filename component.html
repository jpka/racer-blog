<element name="racer-blog" attributes="collectionPath">
  <template>
    <style>
      @host {
        racer-blog {
          display: block;
          margin: 0 auto;
          width: 600px;
        }
      }
      #new {
        border: 2px solid black !important;
      }
    </style>
    <smart-post id="new" on-save="addNew" fixed="true" editable="true" style="display:none;"></smart-post>
    <racer-list id="list" itemType="smart-post" listType="div" at="{{collectionPath}}" reverse="true" on-model:load="onModelLoad" on-item:delete="onItemDelete"></racer-collection>
  </template>
  <script>
    Polymer.register(this, {
      newText: "Write here",
      ready: function() {
        if (window.racer) {
          this.racer = window.racer;  
        }
        this.$.new.model.body = this.newText;
      },
      get posts() {
        return this.$.list.items;
      },
      set racer(racer) {
        var self = this;

        racer.ready(function(model) {
          self.model = model;
        });
      },
      set model(model) {
        var self = this;

        if (model.get("_page.authorized")) {
          this._authorize();
        }
        model.on("error", function(err) {
          if (err.message === "unauthorized") {
            self._unauthorize();
          }
        });
        this.$.list.model = model;
      },
      onItemDelete: function() {
        this.fire("post:delete");
      },
      onModelLoad: function() {
        var self = this,
        count = 0;

        this.$.list.items.forEach(function(item, i) {
          var update = function() {
            count++;
            if (count >= self.$.list.items.length) {
              item.child.removeEventListener(update);
              self.fire("load");
            }
          };
          item.child.addEventListener("update", update);
        });
      },
      _authorize: function() {
        this.$.list.itemAttributes = {editable: true};
        this.$.new.style.display = "block";
      },
      _unauthorize: function() {
        this.$.list.itemAttributes = null;
        this.$.new.style.display = "none";
        this.posts.forEach(function(post) {
          post.reset();
          post.child.editable = false;
        });
      },
      addNew: function() {
        this.$.list.push(this.$.new.model);
        this.$.new.model.body = this.newText;
      }
    });
  </script>
</element>
